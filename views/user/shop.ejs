<%- include('../layouts/user/header.ejs') %>

<!-- Shop Section -->
<div class="shop-container container-fluid py-5 ">
    <div class="row g-4 pt-5">
        <!-- Filters Column -->
        <div class="col-lg-2">
            <div class="filters-wrapper position-sticky" style="top: 4rem;">
                <div class="card shadow-sm border-0 rounded-4">
                    <div class="card-body p-5">
                        <h6 class="fw-bold mb-3">Filters</h6>
                        <!-- Categories -->
                        <div class="mb-3">
                            <p class="text-muted mb-2 small">Categories</p>
                            <% categories.forEach(category => { %>
                                <div class="form-check custom-checkbox mb-2">
                                    <input class="form-check-input" type="checkbox" value="<%= category._id %>" id="category<%= category._id %>">
                                    <label class="form-check-label small" for="category<%= category._id %>">
                                        <%= category.name %>
                                    </label>
                                </div>
                            <% }); %>
                        </div>
                        <!-- Price Range -->
                        <div class="mb-3">
                            <p class="text-muted mb-2 small">Price Range</p>
                            <input type="range" class="form-range custom-range" min="0" max="1000" id="priceRange">
                            <div class="d-flex justify-content-between mt-2">
                                <span class="price-label text-muted small">₹0</span>
                                <span class="price-label text-muted small">₹1000</span>
                            </div>
                        </div>
                        <!-- Apply Button -->
                        <button class="btn btn-dark btn-sm w-100">Apply</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Column -->
        <div class="col-lg-10">
            <!-- Search Bar -->
            <div class="search-bar mb-4">
                <div class="row g-2">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-start-0" placeholder="Search products...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select">
                            <option selected>Sort by</option>
                            <option>Newest First</option>
                            <option>Price: Low to High</option>
                            <option>Price: High to Low</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-3 p-5">
                <% products.forEach(product => { %>
                    <div class="col">
                        <div class="card product-card h-100 border-0 shadow-sm rounded-3">
                            <div class="product-image-container">
                                <img 
                                    src="<%= product.product_img && product.product_img.length > 0 ? `/uploads/re-image/${product.product_img[0]}` : '/uploads/re-image/default.jpeg' %>" 
                                    class="card-img-top product-image" 
                                    alt="<%= product.name %>"
                                    onerror="this.onerror=null; this.src='/uploads/re-image/default.jpeg';"
                                >
                                <% if (product.quantity <= 0) { %>
                                    <div class="out-of-stock-overlay">Out of Stock</div>
                                <% } %>
                                <button class="wishlist-btn" onclick="toggleWishlist(this, '<%= product._id %>')">
                                    <i class="far fa-heart"></i>
                                </button>
                            </div>
                            <div class="card-body p-3">
                                <h6 class="product-title mb-1"><%= product.name %></h6>
                                <div class="product-details small">
                                    <% if (product.writer) { %>
                                        <div class="text-muted mb-1">
                                            <i class="fas fa-pen me-1"></i><%= product.writer %>
                                        </div>
                                    <% } %>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="current-price">₹<%= product.Sale_price %></span>
                                    <% if (product.quantity > 0) { %>
                                        <span class="badge bg-success-subtle text-success">In Stock</span>
                                    <% } %>
                                </div>
                                <a href="/productDetails?id=<%= product._id %>" class="btn btn-outline-dark btn-sm w-100 mt-2">View Details</a>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-center mt-4">
                <nav aria-label="Page navigation">
                    <ul class="pagination pagination-sm">
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item active"><a class="page-link bg-dark border-dark" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Custom CSS -->
<style>
    /* Product Card Styling */
    .product-card {
        transition: all 0.3s ease;
        background: #ffffff;
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1) !important;
    }

    .product-image-container {
        position: relative;
        padding-top: 100%;
        overflow: hidden;
        background: #f8f9fa;
    }

    .product-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .product-card:hover .product-image {
        transform: scale(1.05);
    }

    .product-title {
        font-size: 0.9rem;
        font-weight: 500;
        line-height: 1.3;
        color: #333;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .current-price {
        font-size: 1rem;
        font-weight: 600;
        color: #000000;
    }

    /* Stock Badge */
    .badge {
        font-size: 0.7rem;
        font-weight: 500;
        padding: 0.35em 0.65em;
    }

    .bg-success-subtle {
        background-color: rgba(0, 0, 0, 0.1) !important;
    }

    .text-success {
        color: #000000 !important;
    }

    /* Button Styling */
    .btn-outline-dark {
        border-width: 1px;
    }

    .btn-sm {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }

    /* Out of Stock Overlay */
    .out-of-stock-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.8rem;
        font-weight: 500;
    }

    /* Custom Range Slider */
    .custom-range::-webkit-slider-thumb {
        background: #000000;
    }

    .custom-range::-webkit-slider-runnable-track {
        background: #e9ecef;
    }

    /* Form Controls */
    .form-control:focus, .form-select:focus {
        border-color: #000000;
        box-shadow: 0 0 0 0.25rem rgba(0, 0, 0, 0.25);
    }

    .input-group-text {
        background: #ffffff;
        border-right: none;
    }

    .form-control {
        border-left: none;
    }

    /* Custom Checkbox */
    .custom-checkbox .form-check-input:checked {
        background-color: #000000;
        border-color: #000000;
    }

    /* Pagination Styling */
    .page-link {
        color: #000000;
    }

    .page-item.active .page-link {
        background-color: #000000;
        border-color: #000000;
        color: #ffffff;
    }

    .page-link:hover {
        color: #000000;
        background-color: #e9ecef;
        border-color: #dee2e6;
    }

    .page-link:focus {
        box-shadow: 0 0 0 0.25rem rgba(0, 0, 0, 0.25);
    }

    /* Wishlist Button */
    .wishlist-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        border: none;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .wishlist-btn:hover {
        transform: scale(1.1);
    }

    .wishlist-btn i {
        font-size: 1.2rem;
        color: #000;
        transition: all 0.3s ease;
    }

    .wishlist-btn.active i {
        color: #ff0000;
    }

    .wishlist-btn.active .far.fa-heart {
        font-weight: 900;
    }
</style>

<script>
function toggleWishlist(button, productId) {
    button.classList.toggle('active');
    let icon = button.querySelector('i');
    if (button.classList.contains('active')) {
        icon.classList.remove('far');
        icon.classList.add('fas');
        // Add to wishlist
        fetch('/add-to-wishlist', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ productId: productId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Optional: Show success message
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Revert the icon if there's an error
            button.classList.remove('active');
            icon.classList.remove('fas');
            icon.classList.add('far');
        });
    } else {
        icon.classList.remove('fas');
        icon.classList.add('far');
        // Remove from wishlist
        fetch('/remove-from-wishlist', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ productId: productId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Optional: Show success message
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Revert the icon if there's an error
            button.classList.add('active');
            icon.classList.remove('far');
            icon.classList.add('fas');
        });
    }
}
</script>

<%- include('../layouts/user/footer.ejs') %>
